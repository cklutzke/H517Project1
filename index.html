<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>H517 - Project 1</title>
	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
	<style>
		svg .street {
			stroke: gray;
			stroke-width: 1px;
			fill: none;
		}
		
		svg .pump {
			fill: black;
			stroke: none;
			r: 5;
		}
		
		svg .death {
			fill: red;
			stroke: none;
			r: 2;
		}
		
	</style>
</head>
<body>

	<svg id="map" width="500px" height="500px">
	</svg>
	<svg id="graph" width="500px" height="500px">
	</svg>

	
	<script type="text/javascript">
	
		// TODO: Can I make the size of the SVGs responsive?
	
		let map = d3.select("svg#map");
		
		// NOTE: parseInt strips off "px", but won't work if the size is set by percentage.
		let mapHeight = parseInt(map.style("height"));
		let mapWidth = parseInt(map.style("width"));
		
		let mapXScale = d3.scale.linear();
		let mapYScale = d3.scale.linear();
		
		let streets = [];
		let pumps = [];
		let deaths = [];
		
		function loadDeathDays() {
			d3.csv("deathdays.csv", function(data) {
				let deathId = 0;
				for (let i=0; i < data.length; i++) {
					for (let j=0; j < +data[i].deaths; j++) {
						deaths[deathId++].deathdate = data[i].date;
					}
				}
			});
		}
		
		function drawDeaths() {
			d3.csv("deaths_age_sex.csv", function(data) {
				for (let i=0; i < data.length; i++) {
					deaths.push(
						{
							x: data[i].x,
							y: data[i].y,
							age: data[i].age,
							gender: data[i].gender
						}
					);
				}
				
				loadDeathDays();
				
				map.selectAll('.death')
					.data(deaths)
					.enter()
					.append('circle')
					.attr('class', 'death')
					.attr('cx', function(d) { return mapXScale(d.x); })
					.attr('cy', function(d) { return mapYScale(d.y); });
				
			});
		}

		function drawPumps() {
			d3.csv("pumps.csv", function(data) {
				for (let i=0; i < data.length; i++) {
					pumps.push(
						{x: data[i].x, y: data[i].y}
					);
				}
				
				map.selectAll('.pump')
					.data(pumps)
					.enter()
					.append('circle')
					.attr('class', 'pump')
					.attr('cx', function(d) { return mapXScale(d.x); })
					.attr('cy', function(d) { return mapYScale(d.y); });
					
				drawDeaths();
			});
		}
		
		let lineFunction = d3.svg.line()
			.x(function(d) { return mapXScale(d.x); })
			.y(function(d) { return mapYScale(d.y); })
			.interpolate("linear");
		
		d3.json("streets.json", function(data) {
			streets = data;
		
			// TODO: Set the scales based upon the data.
			mapXScale.domain([0,20]).range([0, mapWidth]);
			mapYScale.domain([0,20]).range([mapHeight, 0]);
			
			for (let i=0; i < streets.length; i++) {
				map.append("path")
					.attr("d", lineFunction(streets[i]))
					.attr("class", "street");
			}
			
			drawPumps();
		});
				
	</script>
</body>


</html>
